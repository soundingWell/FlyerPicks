<!DOCTYPE html>
<html>
<head>
  <title>NFL Lines</title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<!-- 1. Include the client library -->
  <script src="https://cdn.import.io/js/2.0.0/importio.js"></script>

<!-- 2. Configure the library -->
  <script type="text/javascript">
    importio.init({
      "auth": {
        "userGuid": "c5bc637c-83e5-452b-9dc9-e12d67aca440",
        "apiKey": "mcPE9evjS4sGBObjYNZOPnOXOdGdlwLzFFLiDdF2LzYyI5rX9jjiW0nPh9eU3ZVhifXtBjnlfPnsnlIiUcUWmw=="
      },
      "host": "import.io"
    });
    
    
    var curr_bets = [];
    
    var valid_bet = function(pick) { 
      
      if (curr_bets[pick] == true) {
        document.write("Can't make that bet twice");
        return false;
      }
      
      else {
        curr_bets[pick] = true;
        return true;
      }
    }
    
    var send_pick = function(pick, spread, bet_amount) {
         // document.write("<br />" + "Pick to send " + pick + " " + spread + " " + bet_amount + "<br />");
      
        var pick_json = JSON.stringify({pick: pick, spread: spread, bet_amount: bet_amount});
        // document.write(pick_json);
      
        $.ajax({
            type: "POST",
            url: "/nfl",
            dataType: "json",
            data: pick_json,
            success: function (data) {
                alert('Success');
            },
            error: function () {
                alert('Error');
            }
        });
        
        window.location.replace("/nfl");
    }
    
    var bet_slip = function(pick, spread) {
       
       if (valid_bet(pick) == true)
       {
         if (Object.keys(curr_bets).length <= 1) { 
           document.write("<b> Bet Slip </b>" + "<br /><br />");
         }
         
         document.write(pick + " " + spread + " ");
         var bet_amt_text = document.createElement("INPUT");
         bet_amt_text.setAttribute("type", "text");
         bet_amt_text.placeholder = "bet amount $";
         bet_amt_text.id = pick + "txt";
         document.body.appendChild(bet_amt_text);  // Append <button> to <body>
         document.write("&nbsp;&nbsp;&nbsp;");
         
         // ---- make bet btn
         var make_bet_btn = document.createElement("BUTTON"); // Create a <button> element
         var t = document.createTextNode("Make Bet");  
        
         make_bet_btn.id = pick;
         make_bet_btn.value = spread;
        
         make_bet_btn.onclick = function() { 
           send_pick(this.id, this.value, document.getElementById(this.id + "txt").value); 
         };
         
         make_bet_btn.appendChild(t);  // Append the text to <button>
         document.body.appendChild(make_bet_btn);  // Append <button> to <body>
         document.write("<br /><br />");
       }
    }
    
    var displayLines = function(lineArr) {
    
      document.write("<b> NFL Lines </b>" + "<br /><br />");
      
      var curr_line_obj = null;
      var pick1_btn = null;
      for (var curr_line = 0; curr_line < lineArr.length; curr_line++) {
        
        curr_line_obj = lineArr[curr_line]
        
        //-----Pick 1
        pick1_btn = document.createElement("BUTTON"); // Create a <button> element
        var t = document.createTextNode(curr_line_obj.pick_1 + ' ' + curr_line_obj.spread_1);  
        
        pick1_btn.appendChild(t);  // Append the text to <button>
        
        pick1_btn.id = curr_line_obj.pick_1;
        pick1_btn.value = curr_line_obj.spread_1;
        pick1_btn.onclick = function() { bet_slip(this.id, this.value); };
        document.body.appendChild(pick1_btn);  // Append <button> to <body>
        document.write(" ");  
        //------Pick 2
        var pick2_btn = document.createElement("BUTTON"); // Create a <button> element
        var t = document.createTextNode(curr_line_obj.pick_2 + ' ' + curr_line_obj.spread_2);  
        
        pick2_btn.id = curr_line_obj.pick_2;
        pick2_btn.value = curr_line_obj.spread_2;
        pick2_btn.onclick = function() { bet_slip(this.id, this.value); };

        pick2_btn.appendChild(t);  // Append the text to <button>
        document.body.appendChild(pick2_btn);  // Append <button> to <body>
         document.write(" ");  
         
        //------MoneyLine 1
        if ('moneyline_1' in curr_line_obj) {
         
          var moneyline1_btn = document.createElement("BUTTON"); // Create a <button> element
          var t = document.createTextNode(curr_line_obj.pick_1 + ' ' + curr_line_obj.moneyline_1);  
        
          moneyline1_btn.id = curr_line_obj.pick_1;
          moneyline1_btn.value = curr_line_obj.moneyline_1;
          moneyline1_btn.onclick = function() { bet_slip(this.id, this.value); };
        
          moneyline1_btn.appendChild(t);  // Append the text to <button>
          document.body.appendChild(moneyline1_btn);  // Append <button> to <body>
        
          document.write(" ");  
        }
        
        //------MoneyLine 2
        if ('moneyline_2' in curr_line_obj) {
          var moneyline2_btn = document.createElement("BUTTON"); // Create a <button> element
          var t = document.createTextNode(curr_line_obj.pick_2 + ' ' + curr_line_obj.moneyline_2);  
        
          moneyline2_btn.id = curr_line_obj.pick_2;
          moneyline2_btn.value = curr_line_obj.moneyline_2;
          moneyline2_btn.onclick = function() { bet_slip(this.id, this.value); };
        
          moneyline2_btn.appendChild(t);  // Append the text to <button>
          document.body.appendChild(moneyline2_btn);  // Append <button> to <body>
          // document.write("<i>" + k + "</i>: " + d.data[k] + "<br />");
          
          document.write("     ");
        }
        
        if ('over_under' in curr_line_obj) {
        
          document.write("&nbsp; Over/Under: " + "<b>"  + curr_line_obj.over_under + "</b>" + "&nbsp;&nbsp;&nbsp;&nbsp;");
        
          // ----Over Odds
          var over_odds_btn = document.createElement("BUTTON"); // Create a <button> element
          var t = document.createTextNode(curr_line_obj.over_odds);  
        
          over_odds_btn.appendChild(t);  // Append the text to <button>
          document.body.appendChild(over_odds_btn);  // Append <button> to <body>
         
          document.write(" ");
          
          // ----Under Odds
          var under_odds_btn = document.createElement("BUTTON"); // Create a <button> element
          var t = document.createTextNode(curr_line_obj.under_odds);  
        
          under_odds_btn.appendChild(t);  // Append the text to <button>
          document.body.appendChild(under_odds_btn);  // Append <button> to <body>
         
          document.write(" ");
          
        }
        
        document.write("<br />");
        document.write("<hr>");
      }
      
    }
    // Data and done callbacks
    var dataCallback = function(data) {
      lineArr = [];  // Array to hold line objects
      // document.write("Data received", data);
      
      for (var i = 0; i < data.length; i++) {
        var d = data[i];
        var num_games = d.data["pick_1"].length;  // Find out how many games there are
        
        
        for (var curr_game = 0; curr_game < num_games; curr_game++) {
          var curr_line_obj = new Object();
 
          if ('pick_1' in d.data)
          curr_line_obj.pick_1 = d.data["pick_1"][curr_game];
          
          if ('pick_2' in d.data)
            curr_line_obj.pick_2 = d.data["pick_2"][curr_game];
          
          if ('time' in d.data)
            curr_line_obj.time = d.data["time"][curr_game];
          
          if ('spread_1' in d.data)
            curr_line_obj.spread_1 = d.data["spread_1"][curr_game];
          
          if ('spread_2' in d.data)
            curr_line_obj.spread_2 = d.data["spread_2"][curr_game];
          
          if ('moneyline_1' in d.data)
            curr_line_obj.moneyline_1 = d.data["moneyline_1"][curr_game];
          
          if ('moneyline_2' in d.data) 
            curr_line_obj.moneyline_2 = d.data["moneyline_2"][curr_game];
            
          if ('over_under' in d.data) 
            curr_line_obj.over_under = d.data["over_under"][curr_game];
            
          if ('over_odds' in d.data) 
            curr_line_obj.over_odds = d.data["over_odds"][curr_game];
            
          if ('under_odds' in d.data) 
            curr_line_obj.under_odds = d.data["under_odds"][curr_game];

          lineArr.push(curr_line_obj);
        }
      }

      displayLines(lineArr);
    }
    var doneCallback = function(data) {

      // document.write("Done, all data:", data);
      // document.write("<b>NFL Lines</b><hr>");
    }

// 3. Do the query (when the function is called)
    var doQuery = function() {
      // Query for tile Integrate Page Example
      importio.query({
        "connectorGuids": [
          "5518c97d-3718-48b4-b24c-81d5ea90417e"
        ],
        "input": {
              "input": "query"
        }
      }, { "data": dataCallback, "done": doneCallback });
    }
  </script>
  <body onload="doQuery();">
  </body>
</html>